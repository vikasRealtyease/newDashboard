name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Install and Cache Dependencies
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter=@realtyeaseai/database run db:generate
        env:
          # Use a dummy DATABASE_URL for CI builds (Prisma just needs the schema)
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

  # Job 2: Lint (optional, won't fail the build)
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: install
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run linter
        run: pnpm lint || echo "⚠️ Linting not configured yet"

      - name: Type check
        run: pnpm type-check || echo "⚠️ Type checking not configured yet"

  # Job 3: Build Check (verifies builds work)
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: install
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        app: [web, app]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter=@realtyeaseai/database run db:generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

      - name: Build ${{ matrix.app }}
        run: pnpm --filter=@realtyeaseai/${{ matrix.app }} build
        env:
          # Dummy environment variables for build
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          MONGODB_URI: "mongodb://dummy:dummy@localhost:27017/dummy"
          NEXT_PUBLIC_SUPABASE_URL: "https://dummy.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "dummy-key"
          SUPABASE_SERVICE_ROLE_KEY: "dummy-key"
          NEXTAUTH_SECRET: "dummy-secret-for-ci-builds-only"
          NEXTAUTH_URL: "http://localhost:3000"
          PAYPAL_MODE: "sandbox"
          PAYPAL_CLIENT_ID: "dummy"
          PAYPAL_CLIENT_SECRET: "dummy"
          NEXT_PUBLIC_PAYPAL_CLIENT_ID: "dummy"
          CLOUDINARY_CLOUD_NAME: "dummy"
          CLOUDINARY_API_KEY: "dummy"
          CLOUDINARY_API_SECRET: "dummy"
          NEXT_PUBLIC_WEB_URL: "http://localhost:3000"
          NEXT_PUBLIC_APP_URL: "http://localhost:4000"

  # Job 4: Security Audit (won't fail the build)
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: install
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run security audit
        run: pnpm audit --production || echo "⚠️ Audit completed with warnings"

      - name: Check for high vulnerabilities
        run: pnpm audit --audit-level=high || echo "⚠️ High vulnerabilities found - please review"
